<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>League 7 — Roster Overlay</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0a0a0c; --panel-pad:32px; --gap:28px; --card-radius:24px;
    --text:#f4f4f5; --muted:#c9c9cf; --line:rgba(255,255,255,0.10);
    --capt:#ffd166; --vs-size:180px; --vs-stroke:8px;
  }
  html,body{margin:0;padding:0;width:100%;height:100%;background:var(--bg);color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,"IM Fell English SC",serif;overflow:hidden}
  #overlay{position:relative;width:1920px;height:1080px;margin:0 auto;box-sizing:border-box;
    background:radial-gradient(1200px 600px at 50% 50%,rgba(255,255,255,0.04),transparent 60%),linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0))}
  .wrap{position:absolute;inset:0;display:grid;grid-template-columns:1fr auto 1fr;gap:var(--gap);padding:var(--panel-pad);align-items:stretch}
  .team{position:relative;border-radius:var(--card-radius);display:grid;grid-template-rows:auto 1fr;overflow:hidden;
    box-shadow:0 20px 60px rgba(0,0,0,0.45), inset 0 0 0 1px rgba(255,255,255,0.06);isolation:isolate}
  .team-bg{position:absolute;inset:0;background:linear-gradient(135deg,#333,#111);z-index:0}
  .team-sheen{position:absolute;inset:-20%;background:conic-gradient(from 0deg,rgba(255,255,255,.12),transparent 45%,rgba(255,255,255,.12),transparent 70%);
    mix-blend-mode:overlay;filter:blur(40px);opacity:.35;z-index:0;animation:spin 18s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .head{position:relative;z-index:1;display:grid;grid-template-columns:96px 1fr;gap:20px;align-items:center;
    padding:22px 26px;background:linear-gradient(to bottom,rgba(0,0,0,.35),rgba(0,0,0,0));border-bottom:1px solid var(--line)}
  .logo-box{width:96px;height:96px;border-radius:16px;overflow:hidden;display:grid;place-items:center;background:rgba(0,0,0,.35);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
  .logo{width:86px;height:86px;object-fit:contain;display:none}
  .logo.visible{display:block}
  .meta{display:grid;gap:8px;min-width:0}
  .team-name{font-family:"IM Fell English SC",serif;font-size:44px;line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    text-shadow:0 2px 0 rgba(0,0,0,.4)}
  .tag{font-weight:600;font-size:14px;letter-spacing:.4px;text-transform:uppercase;color:var(--muted)}
  .roster{position:relative;z-index:1;display:grid;gap:10px;padding:22px 26px 28px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);
    font-size:12px;letter-spacing:.4px;text-transform:uppercase;color:var(--capt);margin-bottom:8px}
  .pill.muted{color:var(--muted)}
  .player{padding:10px 12px;border-radius:12px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.10);
    font-size:20px;line-height:1.15;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;box-shadow:0 6px 18px rgba(0,0,0,.18)}
  .captain{border-color:rgba(255,209,102,.55);box-shadow:0 8px 28px rgba(255,209,102,.18)}
  .center{width:280px;display:grid;place-items:center;position:relative}
  .vs-wrap{position:relative;width:var(--vs-size);height:var(--vs-size);display:grid;place-items:center;filter:drop-shadow(0 12px 26px rgba(0,0,0,.55))}
  .vs-ring{position:absolute;inset:0;border-radius:50%;
    background:radial-gradient(circle at 50% 50%,rgba(255,255,255,.25),rgba(255,255,255,0) 55%),
      conic-gradient(from 0deg,rgba(255,255,255,.25),rgba(255,255,255,0) 40%,rgba(255,255,255,.25),rgba(255,255,255,0) 70%);
    mask:radial-gradient(circle,transparent calc(50% - var(--vs-stroke)), black calc(50% - var(--vs-stroke)));animation:pulse 2.6s ease-in-out infinite;opacity:.75}
  @keyframes pulse{0%,100%{transform:scale(1);opacity:.75}50%{transform:scale(1.04);opacity:1}}
  .vs{font-family:"IM Fell English SC",serif;font-size:86px;letter-spacing:2px;background:linear-gradient(180deg,#fff,#d8d8d8);
    -webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 3px 0 rgba(0,0,0,.45)}
  .status{position:absolute;inset:0;display:grid;place-items:center;color:var(--muted)}
  .hide{display:none!important}
  @media (max-width:1919px),(max-height:1079px){#overlay{width:100vw;height:100vh}.team-name{font-size:clamp(28px,4vw,44px)}.player{font-size:clamp(16px,1.9vw,20px)}.vs{font-size:clamp(64px,7vw,86px)}}
</style>
</head>
<body>
<div id="overlay">
  <div id="loading" class="status">Loading…</div>

  <div id="content" class="wrap hide">
    <section class="team" id="A">
      <div class="team-bg" id="bgA"></div><div class="team-sheen"></div>
      <header class="head">
        <div class="logo-box"><img id="logoA" class="logo" alt=""></div>
        <div class="meta"><div class="team-name" id="nameA">Team A</div><div class="tag" id="tagA"></div></div>
      </header>
      <div class="roster" id="listA"></div>
    </section>
    <div class="center"><div class="vs-wrap"><div class="vs-ring"></div><div class="vs">VS</div></div></div>
    <section class="team" id="B">
      <div class="team-bg" id="bgB"></div><div class="team-sheen"></div>
      <header class="head">
        <div class="logo-box"><img id="logoB" class="logo" alt=""></div>
        <div class="meta"><div class="team-name" id="nameB">Team B</div><div class="tag" id="tagB"></div></div>
      </header>
      <div class="roster" id="listB"></div>
    </section>
  </div>
</div>

<script>
/* ===== Google Sheet (Team Information) =====
   A TeamName | B Tag | C Primary | D Secondary | E PlayerCaptain | F..O Player2..Player10
*/
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSE9zzuZk-G-NTbxyXn9EkrMyUVoDexXP2Hu3vpuMsQPrLhxF_MxqSw-oNhC2BMs__dINFP3RR6f4sF/pub?gid=495267531&single=true&output=csv";

const FALLBACK_LOGO = "./images/teams/missing_logo.png";
const $ = s => document.querySelector(s);

/* Slug helpers for local logo files */
const slug = s => String(s||"")
  .normalize("NFKD").replace(/[\u0300-\u036f]/g,"")
  .toLowerCase()
  .replace(/&/g,"and")
  .replace(/[^a-z0-9]+/g,"_")
  .replace(/^_+|_+$/g,"");

function logoCandidates(team){
  const out = [];
  // If a URL is ever provided in the sheet, try it first
  if (team?.logo && !/^(?:-|n\/a)$/i.test(team.logo)) out.push(team.logo.trim());
  // Prefer name-based file
  if (team?.name) out.push(`./images/teams/${slug(team.name)}.png`);
  // Tag-based file as a fallback
  if (team?.tag) out.push(`./images/teams/${slug(team.tag)}.png`);
  return out.filter(Boolean);
}

function setPanelGradient(id,c1,c2){
  const el = typeof id==="string" ? document.getElementById(id) : id;
  const normHex = h => { if(!h) return null; const v=h.trim().replace(/^#/,""); return /^[0-9a-fA-F]{3,8}$/.test(v) ? `#${v}` : null; };
  el.style.background = `linear-gradient(135deg, ${normHex(c1)||"#333"}, ${normHex(c2)||"#111"})`;
}

/* Always try local images first, then fallback */
function setLogo(img, team){
  const tries = [...new Set(logoCandidates(team))];
  let i = 0;
  const next = () => {
    if (i >= tries.length){ img.src = FALLBACK_LOGO; img.classList.add("visible"); return; }
    img.onload = () => img.classList.add("visible");
    img.onerror = next;
    img.src = tries[i++];
  };
  next();
}

function parseCSV(text){
  const rows=[]; let cur=[''], i=0, inQ=false;
  for(const c of text){
    if(c === '"'){ inQ=!inQ; cur[i]+=c; }
    else if(c === ',' && !inQ){ cur.push(''); i++; }
    else if((c === '\n' || c === '\r') && !inQ){
      if(cur.some(x=>x.length)){ rows.push(cur.map(x=>x.replace(/^\s+|\s+$/g,'').replace(/^"|"$/g,'').replace(/""/g,'"'))); }
      cur=['']; i=0;
    } else { cur[i]+=c; }
  }
  if(cur.some(x=>x.length)) rows.push(cur.map(x=>x.replace(/^\s+|\s+$/g,'').replace(/^"|"$/g,'').replace(/""/g,'"')));
  return rows;
}

let TEAMS_CACHE = null;
let SHEET_ERROR = null;

function cleanName(s){
  if(!s) return "";
  return String(s).replace(/\s*(?:\(\s*C\s*\)|\[\s*C\s*\]|-\s*C|\*|captain:?)/ig,'').trim();
}

async function loadTeamTableSafe(){
  if(TEAMS_CACHE || SHEET_ERROR) return TEAMS_CACHE || [];
  try{
    const csv = await (await fetch(SHEET_CSV, {cache:"no-store"})).text();
    const rows = parseCSV(csv);
    const data = [];
    for(let r=1;r<rows.length;r++){
      const row = rows[r]; if(!row?.length) continue;
      const name = (row[0]||"").trim(); if(!name) continue;
      const tag  = (row[1]||"").trim();
      const primary   = (row[2]||"").trim();
      const secondary = (row[3]||"").trim();

      const captainRaw = (row[4]||"").trim();           // E
      const captain = cleanName(captainRaw);
      const others = [];
      for(let i=5;i<=14 && i<row.length;i++){           // F..O
        const v=(row[i]||"").trim();
        if(v && v.toLowerCase()!=="n/a" && v!=="-") others.push(cleanName(v));
      }
      const roster = [];
      if(captain) roster.push(captain);
      roster.push(...others.filter(Boolean));

      data.push({ name, tag, primary, secondary, roster });
    }
    TEAMS_CACHE = data;
  }catch(e){
    console.warn("Sheet load failed. Overlay will still run.", e);
    SHEET_ERROR = e;
    TEAMS_CACHE = [];
  }
  return TEAMS_CACHE;
}

function findTeam(list, query){
  if(!query) return null; const q=query.trim().toLowerCase();
  return list.find(t=>t.name.toLowerCase()===q)
      || list.find(t=>(t.tag||"").toLowerCase()===q)
      || list.find(t=>t.name.toLowerCase().includes(q))
      || null;
}

function renderSide(prefix, team){
  const nameEl = document.getElementById(`name${prefix}`);
  const tagEl  = document.getElementById(`tag${prefix}`);
  const logoEl = document.getElementById(`logo${prefix}`);
  const listEl = document.getElementById(`list${prefix}`);

  nameEl.textContent = team?.name || `Team ${prefix}`;
  tagEl.textContent  = team?.tag || "";
  setLogo(logoEl, team || {});
  setPanelGradient(`bg${prefix}`, team?.primary, team?.secondary);

  listEl.innerHTML = "";
  const roster = Array.isArray(team?.roster) ? team.roster.filter(Boolean) : [];
  if(!roster.length){
    const empty=document.createElement("div");
    empty.className="player"; empty.style.opacity=.65; empty.textContent="No roster listed";
    listEl.appendChild(empty); return;
  }
  const pill1=document.createElement("div"); pill1.className="pill"; pill1.textContent="Captain"; listEl.appendChild(pill1);
  const cap=document.createElement("div"); cap.className="player captain"; cap.textContent=roster[0]; listEl.appendChild(cap);

  const rest=roster.slice(1);
  if(rest.length){
    const pill2=document.createElement("div"); pill2.className="pill muted"; pill2.textContent="Roster"; listEl.appendChild(pill2);
    rest.forEach(p=>{ const li=document.createElement("div"); li.className="player"; li.textContent=p; listEl.appendChild(li); });
  }
}

/* Draw placeholders immediately */
renderSide("A", null);
renderSide("B", null);
document.getElementById("loading").classList.add("hide");
document.getElementById("content").classList.remove("hide");

/* Kick off sheet load */
loadTeamTableSafe();

/* expose helpers for the module block */
window.loadTeamTableSafe = loadTeamTableSafe;
window.findTeam = findTeam;
window.renderSide = renderSide;
</script>

<!-- ===== Firebase RTDB listener ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5mJAchcPP61x--oslD2y-tojorp3ysw8",
  authDomain: "league7overlay.firebaseapp.com",
  projectId: "league7overlay",
  storageBucket: "league7overlay.firebasestorage.app",
  messagingSenderId: "126648845416",
  appId: "1:126648845416:web:06be2078b0c95bbb97a7dd",
  measurementId: "G-QW2NG2BNF9",
  databaseURL: "https://league7overlay-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
try { await signInAnonymously(getAuth(app)); } catch(e) { /* ok if rules allow read */ }
const db = getDatabase(app);

const loadTeamTableSafe = window.loadTeamTableSafe || (async()=>[]);
const findTeam = window.findTeam || (()=>null);
const renderSide = window.renderSide || (()=>{});

onValue(ref(db, "/overlay/selectedTeams"), async (snap) => {
  const v = snap.val() || {};
  const teamAName = (v.teamA || localStorage.getItem("teamA_name") || "Team A");
  const teamBName = (v.teamB || localStorage.getItem("teamB_name") || "Team B");

  const list = await loadTeamTableSafe();
  const A = findTeam(list, teamAName) || { name: teamAName, roster: [] };
  const B = findTeam(list, teamBName) || { name: teamBName, roster: [] };

  renderSide("A", A);
  renderSide("B", B);
});
</script>
</body>
</html>
