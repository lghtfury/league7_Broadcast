<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>League 7 Inâ€‘Game Overlay</title>
  <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">
  <style>
    /* TRANSPARENT for Browser Source */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%; height: 100%;
      background: transparent !important;
      overflow: hidden;
      font-family: 'IM Fell English SC', serif;
    }

    #overlay {
      position: relative;
      width: 1920px;
      height: 1080px;
      box-sizing: border-box;
      /* Border gradient will be set from JS using team colors */
      border: 15px solid;
      border-image: linear-gradient(135deg, #444, #222) 1;
      background: transparent !important;
    }

    /* Optional split color wash under the text for team halves */
    #colorWash {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;        /* under text */
      opacity: 0.18;     /* tweak intensity or set to 0 to disable */
      background: transparent;
    }

    /* Team labels */
    #teamA, #teamB {
      position: absolute;
      top: 35px;
      color: white;
      font-weight: bold;
      font-size: 36px;
      z-index: 2;
      white-space: nowrap;
      max-width: 540px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #teamA { left: 390px; }
    #teamB { left: 1074px; }

    /* Scores (live) */
    #scoreA, #scoreB {
      position: absolute;
      color: black;
      font-size: 56px;
      font-weight: bold;
      text-shadow: 2px 2px 4px #000;
      z-index: 3;
    }
    #scoreA { top: 87px; left: 595px; transform: translateX(-50%); }
    #scoreB { top: 86px; right: 595px; transform: translateX(50%); }
  </style>
</head>
<body>
  <div id="overlay">
    <!-- Optional subtle color tint for left/right halves -->
    <div id="colorWash" aria-hidden="true"></div>

    <!-- Team Names -->
    <div id="teamA">Team A</div>
    <div id="teamB">Team B</div>

    <!-- Live Scores (from panel) -->
    <div id="scoreA">0</div>
    <div id="scoreB">0</div>
  </div>

  <script>
    /***********************
     * CONFIG (optional)
     ***********************/
    // If you later switch to cloud sync (e.g., JSONBin), set JSONBIN_LATEST and flip USE_JSONBIN to true.
    const USE_JSONBIN = false;  // keep false for localStorage (panel + overlay in same browser profile)
    const JSONBIN_LATEST = "https://api.jsonbin.io/v3/b/YOUR_BIN_ID/latest"; // only if you enable cloud sync

    /***********************
     * Utilities
     ***********************/
    function safeColor(hex, fallback = "#222") {
      const v = String(hex || "").trim();
      return /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(v) ? v : fallback;
    }
    function adjustFontSize(id) {
      const el = document.getElementById(id);
      const length = (el.textContent || "").trim().length;
      el.style.fontSize = length > 20 ? "24px" : length > 16 ? "26px" : length > 12 ? "30px" : "36px";
    }
    function setBorderGradient(aHex, bHex) {
      const a = safeColor(aHex, "#444");
      const b = safeColor(bHex, "#222");
      document.getElementById("overlay").style.borderImage = `linear-gradient(135deg, ${a}, ${b}) 1`;
      // Optional split background wash:
      const wash = document.getElementById("colorWash");
      if (wash) {
        wash.style.background = `linear-gradient(to right, ${a} 0%, ${a} 50%, ${b} 50%, ${b} 100%)`;
      }
    }

    /***********************
     * Apply payload to UI
     ***********************/
    function applyPayload(data) {
      if (!data) return;

      // Team Names (prefer full names if provided by panel)
      const teamAName = data.teamAName || data.teamA || "Team A";
      const teamBName = data.teamBName || data.teamB || "Team B";
      document.getElementById("teamA").textContent = teamAName;
      document.getElementById("teamB").textContent = teamBName;
      adjustFontSize("teamA");
      adjustFontSize("teamB");

      // Live Map Scores
      document.getElementById("scoreA").textContent = data.mapScoreA ?? 0;
      document.getElementById("scoreB").textContent = data.mapScoreB ?? 0;

      // Colors from Teams sheet (pushed by panel)
      const aPrimary = data?.teamAColors?.primary;
      const bPrimary = data?.teamBColors?.primary;
      setBorderGradient(aPrimary, bPrimary);
    }

    /***********************
     * LOCAL mode (default)
     * - Listens for panel "Push" via localStorage (same browser profile).
     ***********************/
    function initLocalMode() {
      // Initial render (panel may have already pushed)
      try {
        const initial = JSON.parse(localStorage.getItem("matchData_ingame") || localStorage.getItem("matchData") || "{}");
        if (initial && Object.keys(initial).length) applyPayload(initial);
      } catch (_) {}

      // Live updates on push
      window.addEventListener("storage", (e) => {
        if (e.key === "matchData_ingame" || e.key === "matchData") {
          try {
            const data = JSON.parse(e.newValue || "{}");
            applyPayload(data);
          } catch (_) {}
        }
      });
    }

    /***********************
     * JSONBIN mode (optional)
     * - Polls a public JSON endpoint if panel and overlay can't share localStorage.
     * - Keep Browser Source transparency.
     ***********************/
    let lastVersion = null;
    async function tickJSON() {
      try {
        const res = await fetch(JSONBIN_LATEST, { cache: "no-store" });
        if (!res.ok) throw new Error("Cloud fetch failed: " + res.status);
        const wrapper = await res.json();       // JSONBin returns { record: { ... }, metadata: {...} }
        const data = wrapper?.record || wrapper;
        if (!data) return;
        if (data.version !== lastVersion) {
          lastVersion = data.version;
          applyPayload(data);
        }
      } catch (e) {
        console.error("[Overlay] JSON poll error:", e);
      }
    }
    function initJSONMode() {
      tickJSON();
      setInterval(tickJSON, 3000); // poll every 3s (change to 5s if you want)
    }

    /***********************
     * Boot
     ***********************/
    if (USE_JSONBIN) {
      initJSONMode();
    } else {
      initLocalMode();
    }
  </script>
</body>
</html>
