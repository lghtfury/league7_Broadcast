<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>League 7 — Control Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0a0b0e; --card:#0e1116; --ink:#0b0c10; --line:#1b2438;
    --text:#e8ecf6; --muted:#97a0b3; --ok:#3ecf8e; --warn:#ffcf5a; --err:#ff6b6b; --accent:#5aa0ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,#0a0b0e,#0e1320 55%,#0a0b0e); color:var(--text);
    padding:24px; display:flex; justify-content:center;
  }

  /* TOP/BOTTOM LAYOUT */
  .wrap{
    width:min(1100px,100%);
    display:grid;
    grid-template-columns: 1fr;
    grid-template-rows: auto 1fr;
    gap:20px;
    height: calc(100vh - 48px);
  }

  .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 12px 28px rgba(0,0,0,.35)}

  .match-head{
    background:#000; border:1px solid #222; border-radius:14px; padding:14px; margin-bottom:12px;
    display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center;
  }
  .match-head input, .match-head select{height:40px}

  h2{margin:.4rem 0 1rem 0; font-size:18px}
  label{display:block; font-size:12px; color:#8fa0c7; margin-bottom:6px}
  input[type="text"], input[type="number"], input[type="password"], select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #232b4a; background:#0f1422; color:var(--text); outline:none;
  }
  .stack{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .stack.right{justify-content:flex-end}
  .btn{
    appearance:none; border:1px solid #2a3350; background:#141a2a; color:var(--text);
    padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;
  }
  .btn.primary{background:linear-gradient(180deg,#1e66ff,#1449c0); border:0}
  .btn.ghost{background:transparent}
  .btn.gold{ background:gold; color:black; font-weight:700; }
  .tiny{font-size:11px; color:#8d96ac}

  .team-card{background:var(--ink); border:1px solid var(--line); border-radius:12px; padding:12px}

  .team-head{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:16px;
    align-items:end;
  }
  .color-group{
    display:grid;
    grid-template-columns: auto auto auto 18px auto auto auto;
    gap:8px 10px;
    align-items:center;
  }
  .color-group .lbl{font-size:12px; color:#8fa0c7; margin:0 8px 0 0}
  .sw{width:22px; height:22px; border-radius:6px; border:2px solid rgba(255,255,255,.9); box-shadow:0 0 6px rgba(0,0,0,.5)}
  .hex{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:#b8c4e6; min-width:70px}
  .color-group input[type="color"]{width:38px; height:28px; padding:0; border:0; background:transparent}

  .scoreTotal{
    text-align:center;
    font-size:28px;
    letter-spacing:.5px;
    margin:12px 0 10px;
    color:#cfe0ff;
  }
  .scoreTotal strong{font-size:34px; color:#e9f1ff}
  .scoreBtns{justify-content:center; gap:12px}

  .wrap > .card:last-child{
    min-height:50vh;
    display:flex;
    flex-direction:column;
  }
  .preview{
    position:relative; flex:1; min-height:280px;
    border-radius:14px; overflow:hidden; background:#0b0f19; user-select:none;
    display:flex; align-items:center; justify-content:center; color:#9aa9ce;
  }
  .edge{position:absolute; pointer-events:none}
  .edge.top{left:0; right:0; top:0; height:15px}
  .edge.bottom{left:0; right:0; bottom:0; height:15px}
  .edge.left{left:0; top:0; bottom:0; width:15px}
  .edge.right{right:0; top:0; bottom:0; width:15px}

  pre{max-height:220px; overflow:auto; background:#0f1422; border:1px solid #1e2540; border-radius:10px; padding:10px; color:#c9d4f4}

  .status{font-size:12px; color:#9fb0d8}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}

  .jsonbin{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <!-- TOP: Header + Teams -->
    <div class="card">
      <div class="match-head">
        <div>
          <label>Match ID</label>
          <select id="matchId">
            <option value="">Loading…</option>
          </select>
        </div>
        <div class="stack right">
          <button id="btnClearAll" class="btn ghost">Clear Scores</button>
          <button id="btnPush" class="btn primary">Push to Overlay</button>
          <span id="status" class="status">Idle</span>
        </div>
      </div>

      <!-- Team A -->
      <div class="team-card" style="margin-bottom:12px; position:relative">
        <h2>Team A</h2>

        <div class="team-head">
          <div>
            <label>Name</label>
            <input id="teamAName" type="text" placeholder="Team A" />
          </div>

          <div class="color-group">
            <span class="lbl">Primary Color</span>
            <input id="A1picker" type="color" value="#555555" />
            <span id="A1sw" class="sw"></span>
            <span style="width:18px"></span>
            <span id="A1hex" class="hex">#555555</span>

            <input id="A2picker" type="color" value="#333333" />
            <span id="A2sw" class="sw"></span>
            <span id="A2hex" class="hex" style="grid-column:5 / span 3">#333333</span>
          </div>
        </div>

        <div class="scoreTotal">Score total: <strong><span id="liveA">0</span></strong></div>
        <input id="scoreA" type="number" value="0"
               style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0" aria-hidden="true" />

        <div class="stack scoreBtns">
          <button id="btnAminus30" class="btn ghost">−30</button>
          <button id="btnAminus"   class="btn ghost">−10</button>
          <button id="btnAplus"    class="btn ghost">+10</button>
          <button id="btnAplus30"  class="btn gold">+30</button>
        </div>
      </div>

      <!-- Team B -->
      <div class="team-card" style="position:relative">
        <h2>Team B</h2>

        <div class="team-head">
          <div>
            <label>Name</label>
            <input id="teamBName" type="text" placeholder="Team B" />
          </div>

        <div class="color-group">
            <span class="lbl">Secondary Color</span>
            <input id="B1picker" type="color" value="#333333" />
            <span id="B1sw" class="sw"></span>
            <span style="width:18px"></span>
            <span id="B1hex" class="hex">#333333</span>

            <input id="B2picker" type="color" value="#111111" />
            <span id="B2sw" class="sw"></span>
            <span id="B2hex" class="hex" style="grid-column:5 / span 3">#111111</span>
          </div>
        </div>

        <div class="scoreTotal">Score total: <strong><span id="liveB">0</span></strong></div>
        <input id="scoreB" type="number" value="0"
               style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0" aria-hidden="true" />

        <div class="stack scoreBtns">
          <button id="btnBminus30" class="btn ghost">−30</button>
          <button id="btnBminus"   class="btn ghost">−10</button>
          <button id="btnBplus"    class="btn ghost">+10</button>
          <button id="btnBplus30"  class="btn gold">+30</button>
        </div>
      </div>
    </div>

    <!-- BOTTOM: Preview -->
    <div class="card">
      <h2>Border Preview (matches overlay)</h2>
      <div class="preview" id="preview">
        <div class="edge top"   id="pvTop"></div>
        <div class="edge right" id="pvRight"></div>
        <div class="edge bottom"id="pvBottom"></div>
        <div class="edge left"  id="pvLeft"></div>
        Preview
      </div>

      <div class="card jsonbin" style="margin-top:16px">
        <h2>JSONBin Settings</h2>
        <div class="stack" style="margin-top:10px">
          <button id="btnTest" class="btn">Test Read</button>
          <div class="grow"></div>
          <span id="binStatus" class="status">Bin idle</span>
        </div>
        <pre id="lastJson" style="margin-top:12px">(none)</pre>
      </div>
    </div>
  </div>

<script>
/* ===== helpers & persistent panel cfg ===== */
const $ = s => document.querySelector(s);
const hexOK = v => /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(String(v||'').trim());
const LS_PANEL = 'l7_panel_cfg_v1';

function loadPanelCfg(){
  try{
    const s = JSON.parse(localStorage.getItem(LS_PANEL) || '{}');
    $('#binId') && ($('#binId').value = s.bin || '');
    $('#rememberKey') && ($('#rememberKey').checked = !!s.rememberKey);
    $('#masterKey') && ($('#masterKey').value = s.rememberKey ? (s.masterKey || '') : '');
  }catch{}
}
function savePanelCfg(){
  const cfg = {
    bin: $('#binId')?.value?.trim?.() || '',
    rememberKey: $('#rememberKey')?.checked || false,
    masterKey: ($('#rememberKey')?.checked ? $('#masterKey')?.value : '') || ''
  };
  localStorage.setItem(LS_PANEL, JSON.stringify(cfg));
}

/* ===== CSV helpers (Google Sheets publish-to-csv) ===== */
const MATCHES_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSE9zzuZk-G-NTbxyXn9EkrMyUVoDexXP2Hu3vpuMsQPrLhxF_MxqSw-oNhC2BMs__dINFP3RR6f4sF/pub?gid=834810832&single=true&output=csv";
const TEAMS_CSV   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSE9zzuZk-G-NTbxyXn9EkrMyUVoDexXP2Hu3vpuMsQPrLhxF_MxqSw-oNhC2BMs__dINFP3RR6f4sF/pub?gid=495267531&single=true&output=csv";

function parseCSV(text){
  const rows=[]; let cur=[''], i=0, inQ=false;
  for(const c of text){
    if(c === '"'){ inQ = !inQ; cur[i]+=c; }
    else if(c === ',' && !inQ){ cur.push(''); i++; }
    else if((c === '\n' || c === '\r') && !inQ){
      if(cur.some(x=>x.length)){ rows.push(cur.map(x=>x.replace(/^\s+|\s+$/g,'').replace(/^"|"$/g,'').replace(/""/g,'"'))); }
      cur=['']; i=0;
    } else { cur[i]+=c; }
  }
  if(cur.some(x=>x.length)) rows.push(cur.map(x=>x.replace(/^\s+|\s+$/g,'').replace(/^"|"$/g,'').replace(/""/g,'"')));
  return rows;
}

/* ===== preview (mirrors overlay borders) ===== */
function renderPreview(){
  const A1 = $('#A1hex').textContent.trim();
  const A2 = $('#A2hex').textContent.trim();
  const B1 = $('#B1hex').textContent.trim();
  const B2 = $('#B2hex').textContent.trim();
  $('#pvLeft').style.background   = `linear-gradient(to bottom, ${A1}, ${A2})`;
  $('#pvRight').style.background  = `linear-gradient(to bottom, ${B1}, ${B2})`;
  $('#pvTop').style.background    = `linear-gradient(to right, ${A1}, ${B1})`;
  $('#pvBottom').style.background = `linear-gradient(to right, ${A2}, ${B2})`;
}

/* ===== wire color pickers ===== */
function wireColor(id){
  const pick = $('#'+id+'picker');
  const sw   = $('#'+id+'sw');
  const hex  = $('#'+id+'hex');
  const update = () => {
    const val = pick.value.toUpperCase();
    sw.style.background = val;
    hex.textContent = val;
    renderPreview();
  };
  pick.addEventListener('input', update);
  update();
}
['A1','A2','B1','B2'].forEach(wireColor);

/* ===== scores ===== */
function syncTotalsFromInputs(){
  const a = Number($('#scoreA')?.value) || 0;
  const b = Number($('#scoreB')?.value) || 0;
  $('#liveA').textContent = a;
  $('#liveB').textContent = b;
}
const clamp0 = n => Math.max(0, n|0);
function addScore(id, delta){
  const el = $(id);
  el.value = clamp0((+el.value || 0) + delta);
  syncTotalsFromInputs();
}
$('#btnAminus30').onclick = ()=> addScore('#scoreA', -30);
$('#btnAminus').onclick   = ()=> addScore('#scoreA', -10);
$('#btnAplus').onclick    = ()=> addScore('#scoreA', +10);
$('#btnAplus30').onclick  = ()=> addScore('#scoreA', +30);

$('#btnBminus30').onclick = ()=> addScore('#scoreB', -30);
$('#btnBminus').onclick   = ()=> addScore('#scoreB', -10);
$('#btnBplus').onclick    = ()=> addScore('#scoreB', +10);
$('#btnBplus30').onclick  = ()=> addScore('#scoreB', +30);

$('#btnClearAll').onclick = ()=>{
  $('#scoreA').value = 0;
  $('#scoreB').value = 0;
  syncTotalsFromInputs();
};

/* ===== payload for Firestore push ===== */
function collectPayload(){
  return {
    teamAName: $('#teamAName').value || 'Team A',
    teamBName: $('#teamBName').value || 'Team B',
    mapScoreA: Number($('#scoreA').value) || 0,
    mapScoreB: Number($('#scoreB').value) || 0,
    teamAColors: { primary: $('#A1hex').textContent.trim(), secondary: $('#A2hex').textContent.trim() },
    teamBColors: { primary: $('#B1hex').textContent.trim(), secondary: $('#B2hex').textContent.trim() },
    version: Date.now()
  };
}
function setStatus(msg, kind){
  const el = $('#status');
  el.textContent = msg;
  el.classList.remove('ok','warn','err');
  if (kind) el.classList.add(kind);
}
function setBinStatus(msg, kind){
  const el = $('#binStatus');
  if(!el) return;
  el.textContent = msg;
  el.classList.remove('ok','warn','err');
  if (kind) el.classList.add(kind);
}

/* ===== JSONBin read (UI hidden) ===== */
const urlLatest = bin => `https://api.jsonbin.io/v3/b/${bin}/latest`;
async function doRead(){
  savePanelCfg();
  const bin = $('#binId')?.value?.trim?.();
  if (!bin) return setBinStatus('Set Bin ID','warn');
  try{
    setBinStatus('Reading…');
    const r = await fetch(urlLatest(bin), { cache:'no-store' });
    if(!r.ok) throw new Error(r.status);
    const data = await r.json();
    $('#lastJson').textContent = JSON.stringify(data?.record || data, null, 2);
    setBinStatus('Read OK', 'ok');
  }catch(e){
    console.error(e);
    setBinStatus('Read failed','err');
  }
}
$('#btnTest')?.addEventListener('click', doRead);

/* ===== Google Sheets: auto-populate on Match ID change ===== */
let MATCH_ROWS = []; // [{id, teamA, teamB}]
let TEAM_COLORS = new Map(); // name -> {primary, secondary}

async function loadTeamColors(){
  const txt = await (await fetch(TEAMS_CSV, {cache:'no-store'})).text();
  const rows = parseCSV(txt);
  for(let i=1;i<rows.length;i++){
    const name = rows[i][0]?.trim();
    const pri  = rows[i][2]?.trim();
    const sec  = rows[i][3]?.trim();
    if(!name) continue;
    const fix = h => h ? (h.startsWith('#') ? h : '#'+h) : '';
    TEAM_COLORS.set(name, { primary: fix(pri), secondary: fix(sec) });
  }
}

async function loadMatches(){
  const txt = await (await fetch(MATCHES_CSV, {cache:'no-store'})).text();
  const rows = parseCSV(txt);
  MATCH_ROWS = [];
  for(let i=2;i<rows.length;i++){
    const row = rows[i];
    const id = (row[3]||'').trim();      // Column D
    const teamA = (row[4]||'').trim();   // Column E
    const teamB = (row[5]||'').trim();   // Column F
    if(id) MATCH_ROWS.push({id, teamA, teamB});
  }
  const sel = $('#matchId');
  sel.innerHTML = `<option value="">Select…</option>` + MATCH_ROWS.map(m=>`<option value="${m.id}">${m.id}</option>`).join('');
}

/* === NEW: publish selected teams (localStorage + RTDB) === */
function publishSelectedTeams(teamAName, teamBName){
  const a = teamAName || ($('#teamAName').value || '');
  const b = teamBName || ($('#teamBName').value || '');

  // localStorage fallback (same-machine overlays)
  localStorage.setItem('teamA_name', a);
  localStorage.setItem('teamB_name', b);

  // Realtime Database (multi-producer overlays)
  if (window.__rtdbSet) {
    window.__rtdbSet({ teamA: a, teamB: b, updatedAt: Date.now() })
      .catch(err => console.warn('RTDB publish failed:', err));
  }
}

function onMatchPicked(){
  const id = $('#matchId').value.trim();
  if(!id) return;
  const m = MATCH_ROWS.find(x=>x.id === id);
  if(!m) return;

  $('#teamAName').value = m.teamA || 'Team A';
  $('#teamBName').value = m.teamB || 'Team B';

  const A = TEAM_COLORS.get(m.teamA) || {};
  const B = TEAM_COLORS.get(m.teamB) || {};

  if(hexOK(A.primary)){ $('#A1picker').value = A.primary; $('#A1picker').dispatchEvent(new Event('input')); }
  if(hexOK(A.secondary)){ $('#A2picker').value = A.secondary; $('#A2picker').dispatchEvent(new Event('input')); }
  if(hexOK(B.primary)){ $('#B1picker').value = B.primary; $('#B1picker').dispatchEvent(new Event('input')); }
  if(hexOK(B.secondary)){ $('#B2picker').value = B.secondary; $('#B2picker').dispatchEvent(new Event('input')); }

  // NEW: publish right away so roster overlay switches instantly
  publishSelectedTeams(m.teamA, m.teamB);

  setStatus(`Loaded from sheet: ${id}`, 'ok');
}

async function boot(){
  loadPanelCfg();
  renderPreview();
  syncTotalsFromInputs();
  try{
    await Promise.all([loadTeamColors(), loadMatches()]);
    $('#matchId').addEventListener('change', onMatchPicked);

    // NEW: manual edits to team name inputs also publish
    let tA, tB;
    $('#teamAName').addEventListener('input', () => {
      clearTimeout(tA); tA = setTimeout(() => publishSelectedTeams(), 150);
    });
    $('#teamBName').addEventListener('input', () => {
      clearTimeout(tB); tB = setTimeout(() => publishSelectedTeams(), 150);
    });

    $('#matchId').options.length ? setStatus('Sheet connected ✔', 'ok') : setStatus('No matches found', 'warn');
  }catch(e){
    console.error(e);
    setStatus('Sheet read failed', 'err');
  }
}
boot();
</script>

<!-- ===== FIREBASE push + live mirror ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
/* NEW: Realtime Database (for roster overlay listener) */
import { getDatabase, ref as rtdbRef, set as rtdbSet } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

/* Your Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyD5mJAchcPP61x--oslD2y-tojorp3ysw8",
  authDomain: "league7overlay.firebaseapp.com",
  projectId: "league7overlay",
  storageBucket: "league7overlay.firebasestorage.app",
  messagingSenderId: "126648845416",
  appId: "1:126648845416:web:06be2078b0c95bbb97a7dd",
  measurementId: "G-QW2NG2BNF9",
  /* If you created RTDB, include its URL here for best performance */
  databaseURL: "https://league7overlay-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const rtdb = getDatabase(app);
const auth = getAuth(app);
await signInAnonymously(auth);

// Choose overlay namespace via ?overlay=… (default "main")
const OVERLAY_ID = new URLSearchParams(location.search).get("overlay") || "main";
const OVERLAY_REF = doc(db, "overlays", OVERLAY_ID);

// Expose a helper so non-module script can call it
window.__rtdbSet = (payload) => rtdbSet(rtdbRef(rtdb, "/overlay/selectedTeams"), payload);

// Live mirror so panel shows overlay totals too
onSnapshot(OVERLAY_REF, (snap) => {
  const data = snap.data() || {};
  const a = Number(data.mapScoreA) || 0;
  const b = Number(data.mapScoreB) || 0;
  const elA = document.getElementById('liveA');
  const elB = document.getElementById('liveB');
  if (elA) elA.textContent = a;
  if (elB) elB.textContent = b;
  // keep hidden inputs in sync with overlay doc
  const sA = document.getElementById('scoreA');
  const sB = document.getElementById('scoreB');
  if (sA) sA.value = a;
  if (sB) sB.value = b;
});

// Push to Firestore on click AND publish selected teams for roster overlay
document.getElementById("btnPush").addEventListener("click", async () => {
  const payload = window.collectPayload();
  try {
    window.setStatus("Pushing…");
    await setDoc(OVERLAY_REF, payload, { merge: true });

    // NEW: also publish the teams so the roster overlay updates everywhere
    await window.__rtdbSet({ teamA: payload.teamAName, teamB: payload.teamBName, updatedAt: Date.now() });

    // Keep localStorage in sync for same-machine overlays
    localStorage.setItem('teamA_name', payload.teamAName || '');
    localStorage.setItem('teamB_name', payload.teamBName || '');

    window.setStatus("Pushed ✔", "ok");
  } catch (e) {
    console.error(e);
    window.setStatus("Push failed", "err");
  }
});
</script>
</body>
</html>
