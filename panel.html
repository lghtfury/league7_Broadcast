<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>League 7 Control Panel</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#fff; padding:20px; }
    h1 { color:#ffd700; }
    input, button { padding:6px; margin:5px; font-size:16px; }
    #matchInfo { margin-top:20px; padding:15px; background:#222; border:1px solid #444; border-radius:10px; }
    .debug { font-size:12px; color:#ccc; margin-top:10px; white-space:pre-wrap; }
    .pill { display:inline-block; padding:2px 6px; border-radius:8px; background:#333; font-size:12px; margin-left:6px; }
  </style>
</head>
<body>
  <h1>ðŸŽ® League 7 Control Panel</h1>

  <label>Match ID: <input type="number" id="matchIdInput" placeholder="e.g. 1"></label>
  <button id="btnLoad">Load Match</button>

  <div id="matchInfo">
    <h2>Match Preview</h2>
    <p><strong>Division:</strong> <span id="division">-</span></p>
    <p><strong>Team A:</strong> <span id="teamAName">-</span><span id="teamATag" class="pill">-</span></p>
    <p><strong>Team B:</strong> <span id="teamBName">-</span><span id="teamBTag" class="pill">-</span></p>
    <p><strong>Series Score (sheet):</strong> <span id="series">-</span></p>
  </div>

  <div style="margin-top:18px; padding:12px; background:#1a1a1a; border:1px solid #333; border-radius:10px;">
    <h3>Live Score (override)</h3>
    <label>Score A: <input id="mapScoreA" type="number" value="0" style="width:64px;"></label>
    <label>Score B: <input id="mapScoreB" type="number" value="0" style="width:64px;"></label>
    <button id="btnPush">ðŸš€ Push to Overlay</button>
  </div>

  <div class="debug" id="debug"></div>

  <script>
    const MATCH_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSE9zzuZk-G-NTbxyXn9EkrMyUVoDexXP2Hu3vpuMsQPrLhxF_MxqSw-oNhC2BMs__dINFP3RR6f4sF/pub?gid=834810832&single=true&output=csv";
    const TEAMS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSE9zzuZk-G-NTbxyXn9EkrMyUVoDexXP2Hu3vpuMsQPrLhxF_MxqSw-oNhC2BMs__dINFP3RR6f4sF/pub?gid=495267531&single=true&output=csv";

    const COL = { DIVISION:2, MATCH_ID:3, TEAM_A:4, TEAM_B:5, SERIES_A:18, SERIES_B:19 };
    const HEADER_ROW_INDEX = 1;
    const norm = s => String(s||"").trim();

    function parseCSV(text){
      return text.split("\n").map(r => r.split(",").map(x=>x.trim()));
    }

    let BY_TAG=new Map(), BY_NAME=new Map();
    async function loadTeams(){
      const res = await fetch(TEAMS_CSV,{cache:"no-store"});
      const raw = parseCSV(await res.text());
      const headers=raw[0];
      const data=raw.slice(1).filter(r=>r.some(x=>x));
      BY_TAG.clear(); BY_NAME.clear();
      for(const r of data){
        const row={}; headers.forEach((h,i)=>row[h]=(r[i]||"").trim());
        if(row.TeamTag) BY_TAG.set(row.TeamTag.toLowerCase(), row);
        if(row.TeamName) BY_NAME.set(row.TeamName.toLowerCase(), row);
      }
    }
    function resolveTeam(q){
      if(!q) return null;
      return BY_TAG.get(q.toLowerCase())||BY_NAME.get(q.toLowerCase())||null;
    }

    async function getMatchRow(matchId){
      const res = await fetch(MATCH_CSV,{cache:"no-store"});
      const rows = parseCSV(await res.text());
      return rows.slice(HEADER_ROW_INDEX+1).find(r=>norm(r[COL.MATCH_ID])===String(matchId));
    }

    let lastPayload=null;

    async function loadMatchData(){
      const matchId = norm(document.getElementById("matchIdInput").value);
      if(!matchId){alert("Enter Match ID");return;}
      if(BY_TAG.size===0) await loadTeams();
      const row = await getMatchRow(matchId);
      if(!row){document.getElementById("debug").textContent=`Match ${matchId} not found`;return;}
      const division=norm(row[COL.DIVISION]);
      const teamA_in=norm(row[COL.TEAM_A]);
      const teamB_in=norm(row[COL.TEAM_B]);
      const seriesA=norm(row[COL.SERIES_A])||"0";
      const seriesB=norm(row[COL.SERIES_B])||"0";
      const A=resolveTeam(teamA_in)||{TeamTag:teamA_in,TeamName:teamA_in};
      const B=resolveTeam(teamB_in)||{TeamTag:teamB_in,TeamName:teamB_in};

      document.getElementById("division").textContent=division;
      document.getElementById("teamAName").textContent=A.TeamName;
      document.getElementById("teamBName").textContent=B.TeamName;
      document.getElementById("teamATag").textContent=A.TeamTag;
      document.getElementById("teamBTag").textContent=B.TeamTag;
      document.getElementById("series").textContent=`${seriesA} - ${seriesB}`;

      lastPayload={matchId,division,
        teamA:A.TeamTag, teamB:B.TeamTag,
        teamAName:A.TeamName, teamBName:B.TeamName,
        teamAColors:{primary:A.PrimaryColor||"#444"},
        teamBColors:{primary:B.PrimaryColor||"#222"},
        seriesScore:`${seriesA}-${seriesB}`,
        mapScoreA:Number(document.getElementById("mapScoreA").value)||0,
        mapScoreB:Number(document.getElementById("mapScoreB").value)||0,
        version:Date.now()
      };
      localStorage.setItem("matchData", JSON.stringify(lastPayload));
    }

    function pushToOverlay(){
      if(!lastPayload){loadMatchData();}
      lastPayload.mapScoreA=Number(document.getElementById("mapScoreA").value)||0;
      lastPayload.mapScoreB=Number(document.getElementById("mapScoreB").value)||0;
      lastPayload.version=Date.now();
      localStorage.setItem("matchData_ingame", JSON.stringify(lastPayload));
      document.getElementById("debug").textContent=`[PUSH] ${lastPayload.teamA} ${lastPayload.mapScoreA} - ${lastPayload.mapScoreB} ${lastPayload.teamB}`;
    }

    document.getElementById("btnLoad").onclick=loadMatchData;
    document.getElementById("btnPush").onclick=pushToOverlay;
  </script>
</body>
</html>
