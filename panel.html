<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
/* RTDB for Rosters */
import { getDatabase, ref, set as rtdbSet } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

/* Firebase config (added databaseURL for RTDB) */
const firebaseConfig = {
  apiKey: "AIzaSyD5mJAchcPP61x--oslD2y-tojorp3ysw8",
  authDomain: "league7overlay.firebaseapp.com",
  projectId: "league7overlay",
  storageBucket: "league7overlay.firebasestorage.app",
  messagingSenderId: "126648845416",
  appId: "1:126648845416:web:06be2078b0c95bbb97a7dd",
  measurementId: "G-QW2NG2BNF9",
  databaseURL: "https://league7overlay-default-rtdb.firebaseio.com"
};

const app  = initializeApp(firebaseConfig);

/* Firestore (Scoreboard) */
const dbFS = getFirestore(app);
const auth = getAuth(app);
await signInAnonymously(auth);

// Overlay namespace via ?overlay=… (default "main")
const OVERLAY_ID  = new URLSearchParams(location.search).get("overlay") || "main";
const OVERLAY_REF = doc(dbFS, "overlays", OVERLAY_ID);

// Mirror overlay totals back into the panel
onSnapshot(OVERLAY_REF, (snap) => {
  const data = snap.data() || {};
  const a = Number(data.mapScoreA) || 0;
  const b = Number(data.mapScoreB) || 0;
  const elA = document.getElementById('liveA');
  const elB = document.getElementById('liveB');
  if (elA) elA.textContent = a;
  if (elB) elB.textContent = b;
  const sA = document.getElementById('scoreA');
  const sB = document.getElementById('scoreB');
  if (sA) sA.value = a;
  if (sB) sB.value = b;
});

// Push to Scoreboard (Firestore)
document.getElementById("btnPushScoreboard").addEventListener("click", async () => {
  const payload = window.collectPayload();
  try {
    window.setStatus("Pushing…");
    await setDoc(OVERLAY_REF, payload, { merge: true });
    window.setStatus("Pushed ✔", "ok");
  } catch (e) {
    console.error(e);
    window.setStatus("Push failed", "err");
  }
});

/* Push to Rosters (Realtime DB) */
const dbRT = getDatabase(app);
document.getElementById("btnPushRosters").addEventListener("click", async () => {
  const teamA = (document.getElementById('teamAName').value || 'Team A').trim();
  const teamB = (document.getElementById('teamBName').value || 'Team B').trim();
  try {
    window.setStatus("Pushing rosters…");
    await rtdbSet(ref(dbRT, "/overlay/selectedTeams"), { teamA, teamB });
    window.setStatus(`Rosters pushed ✔ ${teamA} vs ${teamB}`, "ok");
  } catch (e) {
    console.error(e);
    window.setStatus("Rosters push failed", "err");
  }
});

/* Still placeholders */
const notReady = (label) => () => window.setStatus(`${label}: not connected yet`, "warn");
document.getElementById("btnPushTVT").addEventListener("click", notReady("TVT"));
document.getElementById("btnPushLogos").addEventListener("click", notReady("Logos"));
</script>
