<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>League 7 — Logos & Roster Screen (Sheet‑driven)</title>
  <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0b0e; --panel:#0f1218; --ink:#0d1016; --line:#1a2233;
      --text:#e8ecf6; --muted:#9aa4b6; --gold:#ffd166; --wash:#0b0e14;
      --card:#0e1117; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif}
    .wrap{position:relative;min-height:100vh;display:flex;flex-direction:column}

    /* Top bar */
    .topbar{position:fixed;top:0;left:0;right:0;height:64px;background:linear-gradient(180deg,#0f131a,rgba(15,19,26,.6));display:flex;align-items:center;justify-content:space-between;padding:0 16px 0 24px;border-bottom:1px solid var(--line);z-index:5}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.3px}
    .brand .sig{font-family:'IM Fell English SC',serif;font-size:22px}
    .brand .sub{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.14em}
    .controls{display:flex;align-items:center;gap:10px}
    select{background:#0c1017;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px}

    /* Stage */
    .stage{flex:1;display:flex;align-items:center;justify-content:center;padding:88px 20px 24px}

    /* Logo grids */
    .grid{width:min(1600px,95vw);display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:18px}
    .logoCell{aspect-ratio:1.6/1;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#0e1219,#0a0c11);display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);padding:10px}
    .logoCell img{max-width:100%;max-height:80%;object-fit:contain;image-rendering:auto}
    .logoCell span{font-weight:700;color:var(--muted);font-size:14px}

    /* Split view */
    .split{width:min(1700px,96vw);height:min(860px,75vh);display:grid;grid-template-columns:1.2fr 1fr;gap:22px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:24px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}

    .logoSide{position:relative;display:flex;align-items:center;justify-content:center}
    .logoSide .teamTitle{position:absolute;bottom:0;left:0;right:0;padding:14px 18px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.65));display:flex;align-items:flex-end;justify-content:space-between;gap:12px}
    .teamName{font:800 28px Inter,system-ui;letter-spacing:.2px}
    .divisionBadge{font:700 12px Inter;background:#121723;border:1px solid var(--line);padding:6px 9px;border-radius:999px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}

    .logoWrap{padding:32px;display:flex;align-items:center;justify-content:center}
    .logoWrap img{max-width:90%;max-height:80%;object-fit:contain}

    .rosterSide{padding:22px}
    .rosterHead{display:flex;align-items:center;justify-content:space-between;border-bottom:1px dashed var(--line);padding:10px 6px 16px;margin-bottom:8px}
    .rosterTitle{font:800 22px Inter;letter-spacing:.25px}
    .count{font:700 12px;color:var(--muted)}
    .list{display:grid;grid-template-columns:1fr;gap:10px;max-height:100%;overflow:auto;padding-right:6px}
    .chip{display:flex;align-items:center;gap:10px;border:1px solid var(--line);background:var(--ink);padding:12px 14px;border-radius:14px}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--gold)}
    .player{font:600 16px Inter}

    .hidden{display:none!important}
    .hint{margin-top:8px;color:var(--muted);font-size:12px;text-align:center}

    @media (max-width:1100px){.split{grid-template-columns:1fr;grid-template-rows:1fr 1.2fr;height:auto}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><div class="sig">League 7</div><div class="sub">Logos & Rosters</div></div>
      <div class="controls"><select id="viewSelect" aria-label="Choose view"></select></div>
    </div>

    <div class="stage">
      <div id="gridAll" class="grid hidden"></div>
      <div id="gridWC" class="grid hidden"></div>
      <div id="gridTW" class="grid hidden"></div>

      <div id="splitView" class="split hidden">
        <div class="panel logoSide" id="logoSide">
          <div class="logoWrap"><img id="teamLogo" alt="Team logo" /></div>
          <div class="teamTitle"><div class="teamName" id="teamName"></div><div class="divisionBadge" id="teamDiv"></div></div>
        </div>
        <div class="panel rosterSide">
          <div class="rosterHead"><div class="rosterTitle">Active Roster</div><div class="count" id="rosterCount"></div></div>
          <div class="list" id="rosterList"></div>
          <div class="hint">Tip: Use the dropdown (top-right) to switch views</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== DATA SOURCES (Season 3 published) ======
    // Team Information (A TeamName | B Tag | C Primary | D Secondary | E Captain | F..O players)
    const TEAMS_CSV   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSE9zzuZk-G-NTbxyXn9EkrMyUVoDexXP2Hu3vpuMsQPrLhxF_MxqSw-oNhC2BMs__dINFP3RR6f4sF/pub?gid=495267531&single=true&output=csv";
    // OWL Match Results (C Division | E Team A | F Team B)
    const MATCHES_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSE9zzuZk-G-NTbxyXn9EkrMyUVoDexXP2Hu3vpuMsQPrLhxF_MxqSw-oNhC2BMs__dINFP3RR6f4sF/pub?gid=834810832&single=true&output=csv";

    // Logo lookup helpers (same convention as roster overlay)
    const FALLBACK_LOGO = "./images/teams/missing_logo.png";
    const $ = s => document.querySelector(s);
    const slug = s => String(s||"")
      .normalize("NFKD").replace(/[\u0300-\u036f]/g,"")
      .toLowerCase().replace(/&/g,"and").replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");
    function logoCandidates(team){
      const out = [];
      if (team?.logo && !/^(?:-|n\/a)$/i.test(team.logo)) out.push(team.logo.trim());
      if (team?.name) out.push(`./images/teams/${slug(team.name)}.png`);
      if (team?.tag)  out.push(`./images/teams/${slug(team.tag)}.png`);
      return [...new Set(out)];
    }
    function setLogo(img, team){
      const tries = logoCandidates(team); let i = 0;
      const next = () => {
        if (i >= tries.length){ img.src = FALLBACK_LOGO; img.classList.add("visible"); return; }
        img.onload = () => img.classList.add("visible");
        img.onerror = next; img.src = tries[i++];
      }; next();
    }

    // CSV parser (quote-safe)
    function parseCSV(text){
      const rows=[]; let cur=[''], i=0, inQ=false;
      for(const c of text){
        if(c === '"'){ inQ=!inQ; cur[i]+=c; }
        else if(c === ',' && !inQ){ cur.push(''); i++; }
        else if((c === '\n' || c === '\r') && !inQ){ if(cur.some(x=>x.length)){ rows.push(cur.map(x=>x.replace(/^\s+|\s+$/g,'').replace(/^"|"$/g,'').replace(/""/g,'"'))); } cur=['']; i=0; }
        else { cur[i]+=c; }
      }
      if(cur.some(x=>x.length)) rows.push(cur.map(x=>x.replace(/^\s+|\s+$/g,'').replace(/^"|"$/g,'').replace(/""/g,'"')));
      return rows;
    }

    // Load teams from Team Information sheet
    async function loadTeams(){
      const csv = await (await fetch(TEAMS_CSV, {cache:'no-store'})).text();
      const r = parseCSV(csv);
      const teams = [];
      for(let i=1;i<r.length;i++){
        const row = r[i]; if(!row?.length) continue;
        const name=(row[0]||'').trim(); if(!name) continue;
        const tag =(row[1]||'').trim();
        const primary=(row[2]||'').trim();
        const secondary=(row[3]||'').trim();
        const captain=(row[4]||'').trim();
        const roster=[captain].filter(Boolean);
        for(let c=5;c<=14 && c<row.length;c++){ const v=(row[c]||'').trim(); if(v && v.toLowerCase()!=="n/a" && v!=="-") roster.push(v); }
        teams.push({ name, tag, primary, secondary, roster, division:null });
      }
      return teams;
    }

    // Enrich with division labels from Match Results (first seen wins)
    async function loadDivisions(map){
      try{
        const txt = await (await fetch(MATCHES_CSV, {cache:'no-store'})).text();
        const r = parseCSV(txt);
        for(let i=2;i<r.length;i++){
          const row=r[i]; if(!row?.length) continue;
          const div=(row[2]||'').trim();
          const A=(row[4]||'').trim();
          const B=(row[5]||'').trim();
          if(div){ if(map.has(A) && !map.get(A).division) map.get(A).division=div; if(map.has(B) && !map.get(B).division) map.get(B).division=div; }
        }
      }catch(e){ console.warn("Division sheet read failed (ok early-season)", e); }
    }

    // ===== UI rendering =====
    const gridAll = $('#gridAll');
    const gridWC  = $('#gridWC');
    const gridTW  = $('#gridTW');
    const split   = $('#splitView');
    const select  = $('#viewSelect');

    function clearViews(){ [gridAll, gridWC, gridTW, split].forEach(el=>el.classList.add('hidden')); }
    function makeLogoCell(team){
      const cell=document.createElement('div'); cell.className='logoCell';
      const img=document.createElement('img'); img.alt=team.name+" logo"; img.className='logo';
      setLogo(img, team); cell.appendChild(img); return cell;
    }

    function renderLogoGrid(list, container){
      container.innerHTML=''; list.forEach(t=>container.appendChild(makeLogoCell(t))); container.classList.remove('hidden');
    }

    function renderTeam(team){
      clearViews(); split.classList.remove('hidden');
      const nameEl=$('#teamName'); const divEl=$('#teamDiv'); const logoEl=$('#teamLogo');
      nameEl.textContent = team.name; divEl.textContent = team.division || '';
      logoEl.classList.remove('visible'); setLogo(logoEl, team);
      const list=$('#rosterList'); list.innerHTML=''; (team.roster||[]).forEach(p=>{
        const row=document.createElement('div'); row.className='chip'; row.innerHTML=`<span class=\"dot\"></span><span class=\"player\">${p}</span>`; list.appendChild(row);
      });
      $('#rosterCount').textContent = `${(team.roster||[]).length} players`;
    }

    function buildDropdown(teams){
      select.innerHTML='';
      const add=(v,l)=>{ const o=document.createElement('option'); o.value=v; o.textContent=l; select.appendChild(o); };
      add('wc_all','World Cup All');
      add('tw_all','Triwizard Cup All');
      add('all_logos','All Logos');
      teams.slice().sort((a,b)=>a.name.localeCompare(b.name)).forEach(t=>add(`team::${t.name}`, t.name));
    }

    function renderByValue(val, teams){
      if(val==='all_logos') return renderLogoGrid(teams, gridAll);
      if(val==='wc_all')    return renderLogoGrid(teams.filter(t=>/world\s*cup/i.test(t.division||'')), gridWC);
      if(val==='tw_all')    return renderLogoGrid(teams.filter(t=>/triwizard/i.test(t.division||'')), gridTW);
      if(val?.startsWith('team::')){
        const name = val.slice(6); const team = teams.find(t=>t.name===name) || teams[0]; return renderTeam(team);
      }
      renderLogoGrid(teams.filter(t=>/world\s*cup/i.test(t.division||'')), gridWC);
    }

    (async function boot(){
      // 1) load team table
      const teams = await loadTeams();
      // 2) map by name for division enrichment
      const byName = new Map(teams.map(t=>[t.name, t]));
      await loadDivisions(byName);
      // 3) dropdown + initial render
      buildDropdown(teams);
      const params=new URLSearchParams(location.search); const start=params.get('view')||'wc_all';
      select.value = Array.from(select.options).some(o=>o.value===start)? start : 'wc_all';
      renderByValue(select.value, teams);
      // 4) change handler + URL memory
      select.addEventListener('change', e=>{ const v=e.target.value; renderByValue(v, teams); const url=new URL(location.href); url.searchParams.set('view', v); history.replaceState({},'',url); });
    })();
  </script>
</body>
</html>
