<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Season 03 O.W.L.s Standings</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Inter:wght@600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0a0b0e;
    --cardBack:#0b0c10;
    --gold1:#ffd700; --gold2:#a67c00;
    --text:#e8ecf6;
    --cardW: 220px; --cardH: 300px;
    --trim: 2px; --radius:18px;
    --gap: 28px;
    --flipMs: 360ms;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);}
  *{box-sizing:border-box}

  .title{
    padding:18px 24px 0;
    font-family:"IM Fell English SC",serif;
    font-size:32px; letter-spacing:.4px;
    background:linear-gradient(45deg,var(--gold1),var(--gold2));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-align:center;
  }
  .asof{
    text-align:center; margin-top:2px; margin-bottom:8px;
    font:600 14px/1 Inter,system-ui,sans-serif; color:#b6bed6
  }

  .board{max-width:1800px;margin:0 auto;padding:10px 24px 24px;display:flex;flex-direction:column;gap:32px}
  .row{display:flex;gap:var(--gap);align-items:center}
  .row1{justify-content:flex-start;flex-wrap:wrap}
  .row2{justify-content:space-between}
  .leftPack,.rightPack{display:flex;gap:var(--gap);align-items:center}
  .row3{justify-content:center;flex-wrap:wrap}

  .card{width:var(--cardW);height:var(--cardH);perspective:1000px;position:relative}
  .inner{position:absolute;inset:0;transform-style:preserve-3d;transition:transform var(--flipMs) ease}
  .card.revealed .inner{transform:rotateY(180deg)}
  .face{position:absolute;inset:0;border-radius:var(--radius);backface-visibility:hidden;background:var(--cardBack)}
  .front{transform:rotateY(180deg);background:rgba(18,22,29,.9)}
  .face::before{
    content:"";position:absolute;inset:0;padding:var(--trim);border-radius:calc(var(--radius) + 2px);
    background:linear-gradient(135deg,var(--gold1),var(--gold2));
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none;
  }

  .backWrap{height:100%;display:grid;place-items:center}
  .logoBack{
    width:min(40%,140px);height:auto;opacity:.95;
    object-fit:contain;image-rendering:auto;
    filter:drop-shadow(0 2px 8px rgba(0,0,0,.55));
  }

  .frontWrap{
    height:100%;padding:16px;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;text-align:center
  }
  .rank{
    font:800 36px/1 Inter,system-ui,sans-serif;letter-spacing:.6px;
    background:linear-gradient(45deg,var(--gold1),var(--gold2));
    -webkit-background-clip:text;background-clip:text;color:transparent
  }
  .teamLogo{width:80px;height:80px;object-fit:contain;filter:drop-shadow(0 2px 8px rgba(0,0,0,.45))}
  .teamName{font-family:"IM Fell English SC",serif;font-size:22px;letter-spacing:.3px;line-height:1.1}
  .hidden{display:none}
  .nodata{ color:#b6bed6; font-style:italic }

  @media (max-width: 1400px){
    :root{ --cardW: 200px; --cardH: 280px }
  }
  @media (max-width: 1200px){
    :root{ --cardW: 184px; --cardH: 260px }
  }
</style>
</head>
<body>
  <div class="title">Season 03 O.W.L.s Standings</div>
  <div class="asof" id="asOf">As of —</div>

  <div class="board">
    <div class="row row1" id="row1"></div>
    <div class="row row2">
      <div class="leftPack" id="row2-left"></div>
      <div class="rightPack" id="row2-right"></div>
    </div>
    <div class="row row3" id="row3"></div>
  </div>

<script>
/** ===== CSV endpoint for Match Results (published-to-web CSV) ===== */
const SHEET_2PACX = "2PACX-1vSE9zzuZk-G-NTbxyXn9EkrMyUVoDexXP2Hu3vpuMsQPrLhxF_MxqSw-oNhC2BMs__dINFP3RR6f4sF";
const GID_MATCHES = "834810832";
const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_2PACX}/pub?gid=${GID_MATCHES}&single=true&output=csv`;

/** ===== Assets (match your repo exactly) ===== */
const L7_BACK = "images/assests/L7_logo_full.png";   // misspelling intentional
const FALLBACK_SMALL = "images/assests/L7_logo_small.png";
const TEAM_LOGOS = {}; // optional overrides { "Team Name": "images/teams/custom.png" }

/** ===== DOM ===== */
const $r1  = document.getElementById('row1');
const $r2L = document.getElementById('row2-left');
const $r2R = document.getElementById('row2-right');
const $r3  = document.getElementById('row3');
const $asOf = document.getElementById('asOf');

/** ===== Helpers ===== */
function logoFor(team){
  if (TEAM_LOGOS[team]) return TEAM_LOGOS[team];
  // underscore slug to match your existing naming
  const slug = (team||"").toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
  return `images/teams/${slug}.png`;
}
function isEmptyName(n){ return !n || n==="__EMPTY__"; }
function parseDate(s){ const d=new Date(s); return isNaN(d)?null:d; }

/* Bucket divisions without forcing staff to change names.
   Anything with "world" → World Cup, anything with "tri" → Triwizard. */
function bucketDivision(raw){
  const t = String(raw||"").toLowerCase();
  if (t.includes("world")) return "World Cup";
  if (t.includes("tri"))   return "Triwizard";
  return ""; // ignore anything else
}

/** Robust CSV parse (handles quotes + commas) and auto-detect header line */
function parseCSV(text){
  const rows=[]; let i=0, field="", row=[], inQ=false;
  const pushF=()=>{row.push(field);field="";}; const pushR=()=>{rows.push(row);row=[];};
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c=== '"'){ if(text[i+1]==='"'){field+='"'; i++;} else inQ=false; }
      else field+=c;
    }else{
      if(c=== '"') inQ=true;
      else if(c=== ',') pushF();
      else if(c=== '\n'){ pushF(); pushR(); }
      else if(c!== '\r') field+=c;
    }
    i++;
  }
  if(field.length||row.length){ pushF(); pushR(); }

  // find header row by "Date" in col0 (case-insensitive)
  let start = 0;
  for (let r=0; r<Math.min(rows.length,5); r++){
    if ((rows[r][0]||"").toLowerCase() === "date"){ start = r+1; break; }
  }
  const data=[];
  for (let r=start; r<rows.length; r++){
    const vals = rows[r].map(v => (v??"").trim());
    if (vals.every(v=>v==="")) continue;
    data.push(vals);
  }
  return data;
}

/** ===== Cards ===== */
function makeCard({rank,name}){
  const el=document.createElement('div'); el.className='card';
  const empty = isEmptyName(name);
  const label = empty ? '<span class="nodata">No data</span>' : name;
  const logo  = empty ? '' :
    `<img class="teamLogo" src="${logoFor(name)}" onerror="this.classList.add('hidden')" />`;
  const rankHtml = `<div class="rank">#${rank}</div>`;
  el.innerHTML=`
    <div class="inner">
      <div class="face back"><div class="backWrap">
        <img class="logoBack" src="${L7_BACK}" onerror="this.src='${FALLBACK_SMALL}';this.onerror=null;">
      </div></div>
      <div class="face front">
        <div class="frontWrap">
          ${rankHtml}
          ${logo}
          <div class="teamName">${label}</div>
        </div>
      </div>
    </div>`;
  el.addEventListener('click',()=>{ if(!el.classList.contains('revealed')) el.classList.add('revealed'); });
  return el;
}

/** Keep your original deck layout exactly */
function renderFromLists(WC,TW){
  WC = padTo(WC,7);
  TW = padTo(TW,6);
  $r1.innerHTML=''; $r2L.innerHTML=''; $r2R.innerHTML=''; $r3.innerHTML='';

  // Row 1: WC #1–#5
  WC.slice(0,5).forEach((t,i)=>$r1.appendChild(makeCard({rank:i+1,name:t||"__EMPTY__"})));
  // Row 2 left: WC #6–#7
  WC.slice(5,7).forEach((t,i)=>$r2L.appendChild(makeCard({rank:5+i+1,name:t||"__EMPTY__"})));
  // Row 2 right: TW #1–#2
  TW.slice(0,2).forEach((t,i)=>$r2R.appendChild(makeCard({rank:i+1,name:t||"__EMPTY__"})));
  // Row 3: TW #3–#6
  TW.slice(2,6).forEach((t,i)=>$r3.appendChild(makeCard({rank:2+i+1,name:t||"__EMPTY__"})));
}
function padTo(arr,n){ const out=arr.slice(0,n); while(out.length<n) out.push("__EMPTY__"); return out; }

/** ===== Standings from CSV (matches your sheet columns) =====
 * 0 Date, 1 Staff, 2 Division, 3 MatchID, 4 TeamA, 5 TeamB,
 * 6 spacer, 7 H (G1 A), 8 I (G1 B), 9 J (G2 A), 10 K (G2 B),
 * 11 L (G3 A), 12 M (G3 B), 13 N (G4 A), 14 O (G4 B),
 * 15 P (G5 A), 16 Q (G5 B), 17 spacer, 18 S (SeriesA), 19 T (SeriesB)
 */
function computeStandings(rows){
  const table = {}; // team -> stats
  let latest=null;

  const ensure=(name,div)=>{
    if(!name) return;
    if(!table[name]) table[name]={team:name,division:div,matchW:0,matchL:0,gameW:0,gameL:0,ptsFor:0,ptsAg:0};
  };

  for(const r of rows){
    const dateStr=r[0]||"";
    const divRaw=r[2]||"";
    const A=(r[4]||"").trim();
    const B=(r[5]||"").trim();
    if(!A||!B) continue;

    const bucket=bucketDivision(divRaw);
    if(!bucket) continue;

    const d=parseDate(dateStr); if(d && (!latest||d>latest)) latest=d;

    ensure(A,bucket); ensure(B,bucket);

    // collect game scores (handle short rows safely)
    const idx=[7,8, 9,10, 11,12, 13,14, 15,16];
    const vals=idx.map(i => (r[i]==null||r[i]==="") ? null : Number(r[i]));
    let gwA=0, gwB=0;
    for(let i=0;i<vals.length;i+=2){
      const a=vals[i], b=vals[i+1];
      if(Number.isFinite(a)){ table[A].ptsFor+=a; table[B].ptsAg+=a; }
      if(Number.isFinite(b)){ table[B].ptsFor+=b; table[A].ptsAg+=b; }
      if(Number.isFinite(a)&&Number.isFinite(b)){
        if(a>b) gwA++; else if(b>a) gwB++;
      }
    }

    // series totals with fallback
    const sA = (r[18]!==undefined && r[18]!=="") ? Number(r[18]) : null;
    const sB = (r[19]!==undefined && r[19]!=="") ? Number(r[19]) : null;
    const useA = Number.isFinite(sA) ? sA : gwA;
    const useB = Number.isFinite(sB) ? sB : gwB;

    table[A].gameW += useA; table[A].gameL += useB;
    table[B].gameW += useB; table[B].gameL += useA;
    if(useA>useB){ table[A].matchW++; table[B].matchL++; }
    else if(useB>useA){ table[B].matchW++; table[A].matchL++; }
  }

  const groups={"World Cup":[],"Triwizard":[]};
  Object.values(table).forEach(t=>{ if(groups[t.division]) groups[t.division].push(t); });

  // Rule 5.3 tie-breakers
  const rank=(a,b)=>{
    if(b.matchW!==a.matchW) return b.matchW-a.matchW;             // series wins
    if(b.gameW!==a.gameW)   return b.gameW-a.gameW;               // total game wins
    const awp=(a.gameW+a.gameL)?a.gameW/(a.gameW+a.gameL):0;
    const bwp=(b.gameW+b.gameL)?b.gameW/(b.gameW+b.gameL):0;
    if(bwp!==awp) return bwp-awp;                                  // game win rate
    const ad=a.ptsFor-a.ptsAg, bd=b.ptsFor-b.ptsAg;
    if(bd!==ad) return bd-ad;                                      // point diff
    if(b.ptsFor!==a.ptsFor) return b.ptsFor-a.ptsFor;              // points for
    return a.team.localeCompare(b.team);
  };

  const WC = (groups["World Cup"]||[]).sort(rank).map(t=>t.team);
  const TW = (groups["Triwizard"]||[]).sort(rank).map(t=>t.team);
  return {WC,TW,latest};
}

/** ===== Boot ===== */
(async()=>{
  try{
    const res = await fetch(CSV_URL, {cache:"no-store"});
    if(!res.ok) throw new Error(`CSV fetch failed: ${res.status}`);
    const text = await res.text();

    const rows = parseCSV(text);
    const {WC,TW,latest} = computeStandings(rows);

    renderFromLists(WC,TW);

    if(latest){
      const y=latest.getFullYear(), m=String(latest.getMonth()+1).padStart(2,'0'), d=String(latest.getDate()).padStart(2,'0');
      $asOf.textContent = `As of ${y}-${m}-${d}`;
    } else {
      $asOf.textContent = `As of —`;
    }
  }catch(e){
    console.error(e);
    renderFromLists(
      ["__EMPTY__","__EMPTY__","__EMPTY__","__EMPTY__","__EMPTY__","__EMPTY__","__EMPTY__"],
      ["__EMPTY__","__EMPTY__","__EMPTY__","__EMPTY__","__EMPTY__","__EMPTY__"]
    );
    $asOf.textContent = `As of —`;
  }
})();
</script>

</body>
</html>
